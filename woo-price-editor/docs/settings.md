# Документация по настройкам

## Обзор

Редактор цен WooCommerce предоставляет настраиваемые параметры для управления поведением и внешним видом редактора по умолчанию. Параметры доступны из **Администратор WordPress** → **Редактор цен** → **Настройки**.

## Расположение настроек

- **Путь меню**: Редактор цен → Настройки
- **Требуемое право**: `manage_woocommerce`
- **Имя опции**: `wpe_editor_settings` (хранится в таблице wp_options)
- **Реализация**: WordPress Settings API

## Доступные настройки

### 1. Стартовая категория

**Описание**: управляет, какая категория товаров выбирается по умолчанию при загрузке редактора.

**Тип поля**: выпадающий список

**Варианты**:
- **Все товары** (значение: `all`) — показывает все товары независимо от категории
- Отдельные категории товаров вашего магазина WooCommerce

**Значение по умолчанию**: `all`

**Случай использования**: если в вашем магазине несколько категорий, а вы в основном редактируете товары в определённой категории, вы можете установить эту категорию в качестве стандартной для экономии времени.

**Пример**:
```php
$settings = get_option('wpe_editor_settings');
$start_category = $settings['start_category']; // 'all' или slug категории
```

### 2. Колонки по умолчанию

**Описание**: определяет, какие колонки видны по умолчанию в таблице редактора.

**Тип поля**: несколько флажков

**Доступные колонки**:
- **Артикул** — SKU/номер товара
- **Статус** — статус товара (Опубликовано, Черновик, Приватное, В ожидании)
- **Обычная цена** — базовая цена товара
- **Цена со скидкой** — скидочная цена (если применимо)
- **Налоговый статус** — установка применения налога (Подлежит налогообложению, Только доставка, Нет налога)
- **Налоговый класс** — налоговая классификация
- **Статус наличия** — статус инвентаря (В наличии, Нет в наличии, На заказ)
- **Категории** — категории товаров

**Значения по умолчанию**:
```php
[
    'sku',
    'regular_price',
    'sale_price',
    'stock_status',
    'tax_status',
]
```

**Примечание**: колонки **Товар** (название) и **Действия** всегда видны и не могут быть отключены.

**Случай использования**: настройте представление по умолчанию в соответствии с вашим рабочим процессом. Например, если вы редко изменяете налоговые параметры, вы можете скрыть эти колонки по умолчанию.

**Программный доступ**:
```php
$settings = get_option('wpe_editor_settings');
$default_columns = $settings['default_columns']; // массив ключей колонок
```

### 3. Инструкции

**Описание**: настраиваемый текст справки, отображаемый в верхней части интерфейса редактора для руководства пользователей.

**Тип поля**: многострочная область текста

**Значение по умолчанию**: 
```
Добро пожаловать в Редактор цен WooCommerce! Этот инструмент позволяет вам быстро отредактировать информацию о товарах в большом количестве.

Как использовать:
• Нажмите на любое редактируемое поле для прямого изменения
• Поля цены: введите новые цены, они будут сохранены автоматически при клике в стороне
• Поле названия: нажмите для редактирования, затем нажмите Enter для сохранения или Escape для отмены
• Поля выпадающего списка: выберите новые значения из меню
• Используйте фильтры выше таблицы для сужения списка товаров
• Переключайте видимость колонок, используя флажки колонок
• Все изменения сохраняются автоматически в вашем магазине WooCommerce

Советы:
• Используйте панель поиска для поиска товаров по названию, артикулу или ID
• Фильтруйте по категории, статусу, налоговому статусу или статусу наличия
• Нажмите на значки редактирования или просмотра для открытия товаров в стандартном интерфейсе WooCommerce
```

**Случай использования**: настройте инструкции для конкретного рабочего процесса вашей команды или добавьте рекомендации, специфичные для вашего магазина.

**Форматирование**: простой HTML разрешён через `wp_kses_post()` для базового форматирования (абзацы, разрывы строк и т.д.)

## Методы конфигурации

### Через интерфейс Администратора WordPress

1. Перейдите в **Редактор цен** → **Настройки**
2. Измените нужные параметры
3. Нажмите **Сохранить изменения**
4. Параметры автоматически проверяются и санитизируются

### Программно через код

#### Чтение параметров

```php
// Получить все параметры
$settings = get_option('wpe_editor_settings', WPE_Plugin::get_default_options());

// Доступ к отдельным параметрам
$start_category = $settings['start_category'] ?? 'all';
$default_columns = $settings['default_columns'] ?? [];
$instructions = $settings['instructions'] ?? '';
```

#### Обновление параметров

```php
// Получить текущие параметры
$settings = get_option('wpe_editor_settings', []);

// Изменить конкретный параметр
$settings['start_category'] = 'electronics';

// Обновить в базе данных
update_option('wpe_editor_settings', $settings);
```

#### Сброс к значениям по умолчанию

```php
$defaults = WPE_Plugin::get_default_options();
update_option('wpe_editor_settings', $defaults);
```

## Валидация параметров

Плагин автоматически проверяет и санитизирует все параметры:

### Валидация стартовой категории

- Проверяет наличие категории с помощью `get_term_by()`
- Возвращается к `'all'`, если передана неверная категория
- Отображает уведомление администратора при ошибке валидации

```php
$category = get_term_by('slug', $input['start_category'], 'product_cat');
if ($category && !is_wp_error($category)) {
    $sanitized['start_category'] = $category->slug;
} else {
    // Возврат к значению по умолчанию
    $sanitized['start_category'] = 'all';
}
```

### Валидация колонок по умолчанию

- Проверяет колонки в списке доступных колонок
- Удаляет ключи неверных колонок
- Убеждает, что выбрана хотя бы одна колонка
- Отображает уведомление администратора, если не выбраны колонки

```php
$valid_columns = ['sku', 'status', 'regular_price', 'sale_price', 'tax_status', 'tax_class', 'stock_status', 'categories'];
$sanitized['default_columns'] = array_intersect($input['default_columns'], $valid_columns);

if (empty($sanitized['default_columns'])) {
    // Возврат к значениям по умолчанию
    $sanitized['default_columns'] = $defaults['default_columns'];
}
```

### Валидация инструкций

- Санитизирует HTML с помощью `wp_kses_post()`
- Возвращается к инструкциям по умолчанию, если пусто
- Удаляет потенциально опасные скрипты и теги

```php
$sanitized['instructions'] = wp_kses_post($input['instructions']);
if (empty(trim($sanitized['instructions']))) {
    $sanitized['instructions'] = $this->get_default_instructions();
}
```

## Активация плагина

При активации плагина параметры по умолчанию создаются автоматически, если они не существуют:

```php
public static function activate() {
    $defaults = self::get_default_options();
    $options  = get_option('wpe_editor_settings');

    if (false === $options) {
        add_option('wpe_editor_settings', $defaults);
    } else {
        // Объединение с параметрами по умолчанию для обновлений
        $updated_options = wp_parse_args((array) $options, $defaults);
        update_option('wpe_editor_settings', $updated_options);
    }
}
```

Это гарантирует:
- Новые установки получают параметры по умолчанию
- Существующие установки получают новые параметры при обновлении плагина
- Пользовательские настройки сохраняются при обновлениях

## Параметры в JavaScript

Параметры локализированы в JavaScript для использования в интерфейсе редактора:

```javascript
// Параметры доступны в объекте wpeData
const startCategory = wpeData.startCategory;  // 'all' или slug категории
const defaultColumns = wpeData.defaultColumns; // массив ключей колонок

// Пример: инициализация фильтров со стартовой категорией
if (startCategory !== 'all') {
    $('#filter-category').val(startCategory).trigger('change');
}

// Пример: показать/скрыть колонки в зависимости от значений по умолчанию
defaultColumns.forEach(function(column) {
    $('input[value="' + column + '"]').prop('checked', true);
});
```

**Расположение**: `includes/class-wpe-plugin.php` → `enqueue_admin_assets()`

## Хранилище базы данных

Параметры хранятся как сериализированный массив в таблице опций WordPress:

**Таблица**: `wp_options`
**Имя опции**: `wpe_editor_settings`
**Автозагрузка**: да (загружается на каждой странице для производительности)

**Пример строки базы данных**:
```
option_name: wpe_editor_settings
option_value: a:3:{s:14:"start_category";s:3:"all";s:15:"default_columns";a:5:{i:0;s:3:"sku";i:1;s:13:"regular_price";i:2;s:10:"sale_price";i:3;s:12:"stock_status";i:4;s:10:"tax_status";}s:12:"instructions";s:500:"Добро пожаловать в Редактор цен WooCommerce!...";}
autoload: yes
```

## Миграция и обновления

Плагин обрабатывает миграцию параметров при активации:

1. Проверяет наличие параметров
2. Если нет, создаёт со значениями по умолчанию
3. Если есть, объединяет с параметрами по умолчанию для добавления новых
4. Выполняет необходимые преобразования данных

**Пример миграции** (при обновлении плагина):
```php
// Обработка миграции для существующих установок
if (!isset($options['instructions'])) {
    $updated_options['instructions'] = $defaults['instructions'];
}

// Удаление устаревших значений
if (isset($updated_options['default_columns']) && is_array($updated_options['default_columns'])) {
    $updated_options['default_columns'] = array_diff($updated_options['default_columns'], ['product']);
}

update_option('wpe_editor_settings', $updated_options);
```

## Hooks и Filters

### Доступные фильтры

Плагин предоставляет фильтры для расширения функциональности параметров:

#### Изменение контекста редактора (включая параметры)

```php
add_filter('wpe_editor_context', function($context) {
    // Изменить параметры перед передачей в шаблон
    $context['settings']['custom_option'] = 'custom_value';
    return $context;
});
```

## Решение проблем

### Параметры не сохраняются

**Причина**: пользователь не имеет прав или не пройдена проверка nonce
**Решение**: убедитесь, что пользователь имеет право `manage_woocommerce` и форма nonce действительна

### Параметры сбрасываются на значения по умолчанию

**Причина**: ошибка валидации или повреждённые данные
**Решение**: проверьте уведомления администратора на предмет ошибок валидации; может потребоваться ручное исправление записи базы данных

### Пользовательская категория не отображается

**Причина**: категория была удалена или изменён slug
**Решение**: плагин автоматически возвращается к «Все товары»; обновите параметр на действительную категорию

## Лучшие практики

1. **Тестируйте изменения параметров** на промежуточном сайте перед применением к продакшену
2. **Документируйте пользовательские инструкции**, которые специфичны для вашего рабочего процесса
3. **Просмотрите колонки по умолчанию** на основе наиболее частых задач вашей команды
4. **Храните резервные копии** ваших параметров, если вы сильно настроили инструкции
5. **Используйте стартовую категорию** для оптимизации времени начальной загрузки для больших каталогов
