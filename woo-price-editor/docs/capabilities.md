# Справочник прав доступа

## Обзор

Плагин Редактор цен WooCommerce разработан с соблюдением высоких стандартов безопасности и требует определённых прав WordPress для доступа к его функциям. В этом документе описаны требования к правам доступа для различных функций плагина.

## Основное право: `manage_woocommerce`

Вся функциональность плагина требует право `manage_woocommerce`, которое обычно назначается:

- **Администратор**: полный контроль над сайтом
- **Менеджер магазина**: управление WooCommerce без полного администраторского доступа

## Проверка прав по функциям

### Доступ к меню администратора

**Требуемое право**: `manage_woocommerce`

Пункт меню Редактор цен отображается только для пользователей с правом `manage_woocommerce`. Это реализовано в:

```php
add_menu_page(
    __('Редактор цен WooCommerce', 'woo-price-editor'),
    __('Редактор цен', 'woo-price-editor'),
    'manage_woocommerce',  // Требуемое право
    'woo-price-editor',
    [$this, 'render_placeholder_screen'],
    'dashicons-money-alt',
    56
);
```

**Расположение**: `includes/class-wpe-plugin.php`

### Доступ к странице настроек

**Требуемое право**: `manage_woocommerce`

Подменю Настройки и все операции со страницей настроек требуют `manage_woocommerce`:

```php
add_submenu_page(
    'woo-price-editor',
    __('Настройки редактора цен WooCommerce', 'woo-price-editor'),
    __('Настройки', 'woo-price-editor'),
    'manage_woocommerce',  // Требуемое право
    'wpe-settings',
    [$this, 'render_settings_page']
);
```

**Расположение**: `includes/class-wpe-settings.php`

### Доступ к полноэкранному редактору

**Требуемое право**: `manage_woocommerce`

Перед отображением оболочки редактора плагин проверяет, что пользователь аутентифицирован и имеет требуемое право:

```php
private function ensure_user_can_access() {
    if (!is_user_logged_in()) {
        auth_redirect();
    }

    if (!current_user_can('manage_woocommerce')) {
        wp_die(
            esc_html__('У вас нет прав для доступа к редактору цен WooCommerce.', 'woo-price-editor'),
            esc_html__('Доступ запрещён', 'woo-price-editor'),
            ['response' => 403]
        );
    }
}
```

**Расположение**: `includes/class-wpe-plugin.php`

### Конечные точки AJAX

**Требуемое право**: `manage_woocommerce`

Все конечные точки AJAX проверяют права перед обработкой запросов:

#### Конечные точки, требующие проверки прав:
- `wpe_get_categories` — получение категорий товаров
- `wpe_get_tax_classes` — получение налоговых классов
- `wpe_get_products` — получение списка товаров
- `wpe_update_product` — обновление полей товара

**Код проверки**:
```php
private function verify_request() {
    // Проверка аутентификации
    if (!is_user_logged_in()) {
        return new WP_Error(
            'not_authenticated',
            __('Вы должны быть авторизованы для доступа к этой конечной точке.', 'woo-price-editor'),
            ['status' => 401]
        );
    }

    // Проверка nonce
    $nonce = isset($_REQUEST['nonce']) ? sanitize_text_field(wp_unslash($_REQUEST['nonce'])) : '';
    if (!$nonce || !wp_verify_nonce($nonce, 'wp_rest')) {
        return new WP_Error(
            'invalid_nonce',
            __('Ошибка проверки безопасности.', 'woo-price-editor'),
            ['status' => 403]
        );
    }

    // Проверка прав
    if (!current_user_can('manage_woocommerce')) {
        return new WP_Error(
            'forbidden',
            __('У вас нет прав для управления товарами.', 'woo-price-editor'),
            ['status' => 403]
        );
    }

    return true;
}
```

**Расположение**: `includes/class-wpe-ajax.php`

### Специфичные для товара права

**Требуемое право**: `manage_woocommerce` + проверка товара

При обновлении товара дополнительные проверки убеждают, что пользователь может редактировать конкретный товар:

```php
if (!WPE_Security::can_edit_product($product_id)) {
    $this->send_response(
        new WP_Error(
            'forbidden',
            __('У вас нет прав для редактирования этого товара.', 'woo-price-editor'),
            ['status' => 403]
        )
    );
    return;
}
```

**Расположение**: `includes/class-wpe-ajax.php`

Метод `WPE_Security::can_edit_product()` убеждает, что пользователь имеет как общее право, так и право редактировать конкретный пост товара.

## Предоставление прав

### Для пользовательских ролей

Если нужно предоставить доступ пользовательским ролям:

```php
// Получить роль
$role = get_role('custom_role_slug');

// Добавить право manage_woocommerce
if ($role) {
    $role->add_cap('manage_woocommerce');
}
```

### Использование плагинов

Несколько плагинов помогают управлять правами доступа:
- **User Role Editor** — визуальный интерфейс управления правами
- **Members** — расширенное управление ролями и правами
- **Capability Manager Enhanced** — детальный контроль разрешений

## Соображения безопасности

### Проверка Nonce

Все AJAX запросы должны содержать корректный nonce, созданный с помощью `wp_create_nonce('wp_rest')`. Это предотвращает атаки CSRF.

### Санитизация запросов

Все входящие данные пользователя санитизированы с помощью функций WordPress:
- `sanitize_text_field()` — текстовые вводы
- `absint()` — целочисленные значения
- `wp_unslash()` — удаление слешей из данных

### Регистрация событий

События безопасности логируются для мониторинга:
- Неудачные проверки прав доступа
- Попытки неправомерного обновления товаров
- Ошибки AJAX

**Расположение**: `includes/class-wpe-security.php`

## Ответы об ошибках

### HTTP коды состояния

Плагин возвращает соответствующие HTTP коды состояния:

- **200 OK** — успешный запрос
- **400 Bad Request** — невалидные входные данные
- **401 Unauthorized** — пользователь не авторизован
- **403 Forbidden** — недостаточно прав
- **500 Internal Server Error** — ошибка на сервере

### Примеры сообщений об ошибках

**Не аутентифицирован** (401):
```json
{
    "success": false,
    "message": "Вы должны быть авторизованы для доступа к этой конечной точке.",
    "data": {
        "status": 401
    }
}
```

**Невалидный Nonce** (403):
```json
{
    "success": false,
    "message": "Ошибка проверки безопасности.",
    "data": {
        "status": 403
    }
}
```

**Запрещённый доступ** (403):
```json
{
    "success": false,
    "message": "У вас нет прав для управления товарами.",
    "data": {
        "status": 403
    }
}
```

## Лучшие практики

1. **Никогда не обходить проверки прав** — весь пользовательский код должен соблюдать требование `manage_woocommerce`
2. **Использовать встроенные функции WordPress** — применять `current_user_can()` для всех проверок разрешений
3. **Логировать события безопасности** — мониторить неудачные попытки доступа для аудита безопасности
4. **Тестировать с разными ролями** — проверить, что контроль доступа работает правильно для всех ролей пользователей
5. **Сохранять nonce в актуальном состоянии** — nonce истекают; внедрить надлежащие механизмы обновления в длительных сессиях
